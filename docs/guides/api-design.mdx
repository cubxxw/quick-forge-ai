# Apifox 结合代码库的 API 工程实践指南

## 1. 引言

本指南旨在提供一套结合使用 Apifox（作为 API 设计、文档、测试工具）与后端代码库（如 Node.js, Python, Java, Go 等）的最佳工程实践。核心目标是确保 API 的**设计、文档、实现和测试**在整个生命周期中保持高度一致性、可维护性和协作效率。
同时随着 AI 和 MCP 的兴起，API 面向的群体，就像设计用户产品要考虑用户体验一样，设计 API 要考虑使用它的开发者的体验。好的 API 设计合理，标准化，不仅仅用户好用，其他的业务好接入，对于AI来说也能更好的处理。

## 2. 核心原则：设计优先 (Design-First)

我们推荐采用**设计优先**的方法，将 **Apifox 作为 API 契约（Contract）的“真相之源” (Source of Truth)**。

* **定义：** 所有 API 的端点、请求/响应结构、数据模型、业务错误码等，首先在 Apifox 中进行设计和定义。
* **优势：**
    * 确保设计的统一性和前瞻性。
    * 便于团队评审和早期反馈。
    * 为后续的开发、测试、文档生成奠定清晰的基础。

## 3. 标准工作流程

推荐遵循以下基本工作流程：

1.  **设计/更新 API：** 在 Apifox 中创建或修改 API 设计。
2.  **评审：** 团队成员在 Apifox 中评审设计稿。
3.  **导出规范：** 从 Apifox 导出最新的 OpenAPI 规范文件（推荐 YAML 格式，如 `openapi.yaml`）。
4.  **纳入版本控制：** 将导出的 `openapi.yaml` 文件提交到与后端代码相同的 Git 仓库中。
5.  **实现代码：** 开发者基于 Apifox 的设计（和仓库中的 `openapi.yaml`）编写或更新后端代码逻辑。
6.  **编写测试：**
    * 在代码库中编写单元测试和集成测试。
    * 在 Apifox 中编写契约测试和场景测试用例。
7.  **提交与 CI/CD：** 提交代码和更新后的 `openapi.yaml` 文件，触发 CI/CD 流水线。
8.  **自动化验证：** CI/CD 流水线执行：
    * 代码库测试（单元、集成）。
    * **契约测试**（使用 `openapi.yaml` 验证部署后的服务）。
    * Apifox 自动化测试（通过 Apifox CLI 或 API 调用）。
9.  **部署：** 验证通过后，部署到相应环境。
10. **更新文档/SDK：** 自动或手动更新发布 API 文档和客户端 SDK。

## 4. 关键实践详解

### 4.1 Apifox 作为“真相之源”

* 始终坚持先在 Apifox 中定义或修改 API 结构。
* 利用 Apifox 的数据模型、环境管理、全局参数等功能维护设计的一致性。

### 4.2 导出并版本化 OpenAPI 规范

* **必要性：**
    * **版本一致性：** 将 API 定义与代码实现在 Git 中精确关联，方便追溯历史和版本切换。
    * **Code Review：** API 契约的变更在 PR/MR 中清晰可见。
    * **CI/CD 集成：** 为自动化契约测试、代码生成等提供输入文件。
    * **离线访问与工具链：** 支持本地工具处理 API 定义。
* **操作：**
    * 定期从 Apifox 导出 OpenAPI 3.0 YAML 文件。
    * 将文件存储在代码库的固定位置（如 `api-spec/` 或 `docs/api/`）。
    * 通过 Git 提交管理文件变更。

### 4.3 利用 Mock Server 加速开发

* 在后端实现完成前，使用 Apifox 的 Mock 功能为前端或客户端提供模拟接口。
* 确保 Mock 响应符合 Apifox 中定义的数据结构。

### 4.4 谨慎使用代码生成

* **推荐：** 生成数据模型（DTOs/POJOs/Structs）以减少样板代码。
* **谨慎：** 避免生成完整的业务逻辑或 Controller/Handler 层代码，以免增加维护复杂度。
* **考虑：** 生成客户端 SDK 以方便 API 消费者。

### 4.5 全面的自动化测试

* **代码库测试：** 单元测试、集成测试，覆盖业务逻辑和内部交互。
* **Apifox 自动化测试：** 覆盖 API 的主要功能场景和业务流程。
* **契约测试（CI/CD 中）：** 使用 Dredd、Schemathesis 等工具，基于代码库中的 `openapi.yaml` 文件，严格验证**实际运行的服务**是否符合 API 契约。这是防止设计与实现脱节的关键防线。

### 4.6 CI/CD 深度集成

* 将 OpenAPI 规范文件纳入 Git 是实现深度集成的前提。
* 在流水线中自动执行上述所有类型的测试。
* 自动化 API 文档的构建和发布。
* 自动化客户端 SDK 的生成和发布（如果需要）。

### 4.7 文档管理

* 主要依赖 Apifox 自动生成的文档，因为它直接来源于“真相之源”。
* 确保 Apifox 中的描述、示例足够清晰。
* 将生成的文档发布到易于访问的平台（如内部开发者门户）。

### 4.8 团队协作与规范

* 在 Apifox 中设置合理的团队角色和权限。
* 制定清晰的 API 设计变更流程和评审机制。
* 统一 API 路径、参数、模型字段等的命名规范，并在 Apifox 和代码中保持一致。
